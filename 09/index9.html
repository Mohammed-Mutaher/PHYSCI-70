<!DOCTYPE html>
<html>
<title>Mohammed Mutaher - PHYSCI 70</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="../mystyle.css">

<body class="w3-pale-yellow w3-content" style="max-width:1600px">

<!-- Sidebar/menu -->
<nav class="w3-sidebar w3-collapse w3-white w3-animate-left" style="z-index:3;width:225px;" id="mySidebar"><br>
  <div class="w3-container">
    <a href="#" onclick="w3_close()" class="w3-hide-large w3-right w3-jumbo w3-padding w3-hover-grey" title="close menu">
      <i class="fa fa-remove"></i>
    </a>
    <img src="../Pfp.png" 
      style="object-fit:cover;
        object-position: center;
            width:62px;
            height:62px"
      class="w3-round"><br><br>
    <h4><b>Navigation</b></h4>
  </div>
  <div class="w3-bar-block">
    <a href="https://mohammed-mutaher.github.io/PHYSCI-70/" onclick="w3_close()" class="w3-bar-item w3-button w3-padding"><i class="fa fa-th-large fa-fw w3-margin-right"></i>Home</a> 
    <a href="../about.html" onclick="w3_close()" class="w3-bar-item w3-button w3-padding"><i class="fa fa-user fa-fw w3-margin-right"></i>About Me</a>
    <a href="https://nathanmelenbrink.github.io/ps70/" onclick="w3_close()" class="w3-bar-item w3-button w3-padding"><i class="fa fa-gears fa-fw w3-margin-right"></i>About PHYSCI 70</a>
  </div>
</nav>

<!-- Overlay effect when opening sidebar on small screens -->
<div class="w3-overlay w3-hide-large w3-animate-opacity" onclick="w3_close()" style="cursor:pointer" title="close side menu" id="myOverlay"></div>

<!-- !PAGE CONTENT! -->
<div class="w3-main" style="margin-left:250px">

<!-- Header -->
  <header id="Week 9">
    <a href="#"><img src="/w3images/avatar_g2.jpg" style="width:65px;" class="w3-circle w3-right w3-margin w3-hide-large w3-hover-opacity"></a>
    <span class="w3-button w3-hide-large w3-xxlarge w3-hover-text-grey" onclick="w3_open()"><i class="fa fa-bars"></i></span>
    <div class="w3-container">
    <div class="w3-section w3-padding-10">
    <h1><b>Week 9: Radio, WiFi, Bluetooth (IoT)</b></h1>
    <div class="w3-section w3-bottombar w3-border-white w3-padding-10"> </div>
    </div>
  </header>

<!-- Body -->
<div class="w3-margin-left">
  <body id="Text">
    <div class="w3-container">
    <div class="w3-section w3-padding-10">

      <h5><p> 

      Work in progress!

      <p> This week, we focused on radio, WiFi, and bluetooth (IoT). </p>

      <p> We were tasked with demonstrating communication between a microcontroller and another device. I completed the assignment by following two tutorials, one on the PHYSCI 70 website by Rob Hart and the other by on randomnerdtutorials.com by Rui Santos. Documentation for both projects is provided below. </p>

      <br>

      <p><h3><b> Project 1: Communicating with UART Serial </b></h3></p>

      <p> I followed the tutorial linked <a href="https://roberthart56.github.io/SCFAB/SC_lab/Networking/networking/USART/index.html">here</a> to facilitate communication between the Adafruit Metro microcontroller and an ESP32-based Feather board. The goal was to have a potentionmeter connected to the microcontroller, which would communicate with the ESP32 board to control the position of a servo motor connected to the latter. </p>

      <p> On my first attempt, I replicated the wiring setup in the tutorial and tried to upload the code for both the Metro and ESP32 board provided in the tutorial. The wiring setup and code from the tutorial are shown below. </p>


      <p> Wiring setup: </p>

      <img src="./Wiresetup1.jpg" width="50%" alt="" class="center">

      <p> Metro microcontroller code: </p>

      <pre><code class="language-arduino">
        //Code to transmit
        //Microcontroller has a potentiometer input:  wiper pin attached to analog in.
        //Sends a signal to receiver through the USART transmit pin (TX)  (or TX1 for some boards)

        //Can receive  a signal throught the USART receive pin (RX), but this is not
        // implemented in this simplest sketch.

        //The wired-together devices must share a common ground!

        const int pot_pin = A0;

        void setup() {
          Serial.begin(0);        //for the USB serial devices, this baud rate is meaningless - can be "0"
          Serial1.begin(9600);      //this is the USART SERIAL.  On SAM boards, like Metro M0, ItsyBitsy and D11, this is called "Serial1". Baud rate is important on this one!           
        }

        void loop() {
        int pot_value = analogRead(pot_pin);
        Serial.println(pot_value);          //This is for diagnostic purposes
        Serial1.write(pot_value/4);     //This one is data sent to the other board.  divide by four to make the range 0-255.
        delay(10);
        }
      </code></pre>

      <p> ESP32 board code: </p>

      <pre><code class="language-arduino">
        //Code to move a servomotor in response to a change in input pin.
        //Use as a simple example of receiving for a wired network 3/30/20.  Rob Hart.
        //modified to use with ESP32 Huzzah board July 2020. R.Hart

        #include <ESP32Servo.h>

        Servo myservo;  // create servo object to control a servo

        void setup() {
          myservo.attach(21);  // attaches the servo on pin 9 to the servo object
          Serial.begin(9600);        //for the USB serial devices, this baud rate is meaningless - can be "0"
          Serial1.begin(9600);      //this is the USART SERIAL.  On SAM boards, like ItsyBitsy and D11, this is called "Serial1"
          //Baud rate is important on this one!
        }

        void loop() {
          while (!Serial1.available()) {      //wait until serial from UART is available.
          }

          byte rec_byte =  Serial1.read();    //Here is where the incoming byte is read.
          //Serial.println(rec_byte);       //for diagnosing using USB serial
          int degree = rec_byte*180/255;      //conversion between one byte and 180 degrees.
          Serial.println(degree);           //for diagnosing using USB serial
          myservo.write(degree);
        }
      </code></pre>

      <br>

      <p> The code for the microntroller and the ESP32 board would not upload and the program instead returned error messages for both. First, I focused on the microcontroller code. I quickly realized that the tutorial uses an Adafruit Metro Express microcontroller, which has two serial ports versus the microcontroller I was using, which only has one. Due to the fact that there was no "Serial1" on my board, the code would not upload without an error. So, I deleted the "Serial1.begin(9600);" line under void setup(){} and replaced the "Serial1.write(pot_value/4);" line under void loop(){} with "Serial.write(pot_value/4);". I also commented out the "Serial.println(pot_value);" line in the code. Having made these changes, I also changed the wiring so that instead of one signal wire connecting the TX1 pin on the microcontroller to the RX/16 pin on the ESP32 board, there were two wires (one connecting the microcontroller TX1 pin to the RX/16 pin on the ESP32 board and the other connecting the microcontroller RX0 pin to the TX/17 pin on the ESP32 board). </p>

      <p> With respect to the code for the ESP32 board, I realized that the issue was the use of the ESP32Servo.h library. I downloaded the ESP32 Arduino Servo Library linked <a href="https://github.com/RoboticsBrno/ServoESP32">here</a> and replaced the "#include &lt;ESP32Servo.h&gt;" line in the original code with "#include &lt;Servo.h&gt;". This fixed the uploading issue, and with that I was ready to test the device. The modified wiring setup and code are shown below. </p>

     
      <p> Modified wiring setup: </p>

      <img src="./Wiresetup2.jpg" width="50%" alt="" class="center">

      <p> Modified Metro microcontroller code: </p>

      <pre><code class="language-arduino">
        //Code to transmit
        //Microcontroller has a potentiometer input:  wiper pin attached to analog in.
        //Sends a signal to receiver through the USART transmit pin (TX)  (or TX1 for some boards)

        //Can receive  a signal throught the USART receive pin (RX), but this is not
        // implemented in this simplest sketch.

        //The wired-together devices must share a common ground!

        const int pot_pin = A0;

        void setup() {
          Serial.begin(9600);   
        }

        void loop() {
        int pot_value = analogRead(pot_pin);
        //Serial.println(pot_value);          //This is for diagnostic purposes
        Serial.write(pot_value/4);     //This one is data sent to the other board.  divide by four to make the range 0-255.
        delay(10);
        }
      </code></pre>

      <p> Modified ESP32 board code: </p>

      <pre><code class="language-arduino">
        //Code to move a servomotor in response to a change in input pin.
        //Use as a simple example of receiving for a wired network 3/30/20.  Rob Hart.
        //modified to use with ESP32 Huzzah board July 2020. R.Hart

        #include <Servo.h>

        Servo myservo;  // create servo object to control a servo

        void setup() {
          myservo.attach(21);  // attaches the servo on pin 9 to the servo object
          Serial.begin(9600);        //for the USB serial devices, this baud rate is meaningless - can be "0"
          Serial1.begin(9600);      //this is the USART SERIAL.  On SAM boards, like ItsyBitsy and D11, this is called "Serial1"
          //Baud rate is important on this one!
        }

        void loop() {
          while (!Serial1.available()) {      //wait until serial from UART is available.
          }

          byte rec_byte =  Serial1.read();    //Here is where the incoming byte is read.
          //Serial.println(rec_byte);       //for diagnosing using USB serial
          int degree = rec_byte*180/255;      //conversion between one byte and 180 degrees.
          Serial.println(degree);           //for diagnosing using USB serial
          myservo.write(degree);
        }
      </code></pre>

      <p> Video: </p>

      <div class="w3-center">
        <video width="400" height="300" controls>
        <source src="./Test1.mp4" type=video/mp4>
        </video>
      </div>

      <p> As you can see in the pictures and video above, I powered both the Metro microcontroller and ESP32 separately using USB cables connected to my laptop. I also wanted to see if the microcontroller could be used to power the ESP32 board. I first tried connecting the 3.3V pin on the microcontroller to the the 3V pin on the ESP32 board without success. After looking at the pinout diagram of the ESP32 board, I noticed that there was a USB pin. I promptly connected the 5V pin from the microcontroller to the USB pin on the ESP32 board, and it powered on. </p>

      <div class="row">
        <div class="column2">
          <p> Wiring setup: </p>
          <img src="./Wiresetup3.jpg" alt="" style="width:100%"> </p>
        </div>
        <div class="column2">
          <p> Video: </p>
          <video style="width:100%" controls>
          <source src="./Test2.mp4" type=video/mp4>
          </video> </p>
        </div>
      </div> 

      <br>

      <p><h3><b> Project 2: ESP32 Servo Motor Web Server with Arduino IDE </b></h3></p>

      <p> For my second project, I followed the tutorial linked <a href="https://randomnerdtutorials.com/esp32-servo-motor-web-server-arduino-ide/">here</a> to facilitate communication between the ESP32 board and a servo motor through a web server. The goal was to have a slider on the web server to control the position of the servo motor (between 0ยบ and 180ยบ) using a pulse width modulation (PWM) signal. </p>

      <p> I attached the servo motor to the 13/A12 pin on the ESP32 board and uploaded the following code from the tutorial to it, substituting the wifi name and password for "REPLACE_WITH_YOUR_SSID" and "REPLACE_WITH_YOUR_PASSWORD": </p> 

      <pre><code class="language-arduino">
        /*********
          Rui Santos
          Complete project details at http://randomnerdtutorials.com  
        *********/

        #include <WiFi.h>
        #include <Servo.h>

        Servo myservo;  // create servo object to control a servo
        // twelve servo objects can be created on most boards

        // GPIO the servo is attached to
        static const int servoPin = 13;

        // Replace with your network credentials
        const char* ssid     = "REPLACE_WITH_YOUR_SSID";
        const char* password = "REPLACE_WITH_YOUR_PASSWORD";

        // Set web server port number to 80
        WiFiServer server(80);

        // Variable to store the HTTP request
        String header;

        // Decode HTTP GET value
        String valueString = String(5);
        int pos1 = 0;
        int pos2 = 0;

        // Current time
        unsigned long currentTime = millis();
        // Previous time
        unsigned long previousTime = 0; 
        // Define timeout time in milliseconds (example: 2000ms = 2s)
        const long timeoutTime = 2000;

        void setup() {
          Serial.begin(115200);

          myservo.attach(servoPin);  // attaches the servo on the servoPin to the servo object

          // Connect to Wi-Fi network with SSID and password
          Serial.print("Connecting to ");
          Serial.println(ssid);
          WiFi.begin(ssid, password);
          while (WiFi.status() != WL_CONNECTED) {
            delay(500);
            Serial.print(".");
          }
          // Print local IP address and start web server
          Serial.println("");
          Serial.println("WiFi connected.");
          Serial.println("IP address: ");
          Serial.println(WiFi.localIP());
          server.begin();
        }

        void loop(){
          WiFiClient client = server.available();   // Listen for incoming clients

          if (client) {                             // If a new client connects,
            currentTime = millis();
            previousTime = currentTime;
            Serial.println("New Client.");          // print a message out in the serial port
            String currentLine = "";                // make a String to hold incoming data from the client
            while (client.connected() && currentTime - previousTime <= timeoutTime) { // loop while the client's connected
              currentTime = millis();
              if (client.available()) {             // if there's bytes to read from the client,
                char c = client.read();             // read a byte, then
                Serial.write(c);                    // print it out the serial monitor
                header += c;
                if (c == '\n') {                    // if the byte is a newline character
                  // if the current line is blank, you got two newline characters in a row.
                  // that's the end of the client HTTP request, so send a response:
                  if (currentLine.length() == 0) {
                    // HTTP headers always start with a response code (e.g. HTTP/1.1 200 OK)
                    // and a content-type so the client knows what's coming, then a blank line:
                    client.println("HTTP/1.1 200 OK");
                    client.println("Content-type:text/html");
                    client.println("Connection: close");
                    client.println();

                    // Display the HTML web page
                    client.println("<!DOCTYPE html><html>");
                    client.println("<head><meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">");
                    client.println("<link rel=\"icon\" href=\"data:,\">");
                    // CSS to style the on/off buttons 
                    // Feel free to change the background-color and font-size attributes to fit your preferences
                    client.println("<style>body { text-align: center; font-family: \"Trebuchet MS\", Arial; margin-left:auto; margin-right:auto;}");
                    client.println(".slider { width: 300px; }</style>");
                    client.println("<script src=\"https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js\"></script>");
                             
                    // Web Page
                    client.println("</head><body><h1>ESP32 with Servo</h1>");
                    client.println("<p>Position: <span id=\"servoPos\"></span></p>");          
                    client.println("<input type=\"range\" min=\"0\" max=\"180\" class=\"slider\" id=\"servoSlider\" onchange=\"servo(this.value)\" value=\""+valueString+"\"/>");
                    
                    client.println("<script>var slider = document.getElementById(\"servoSlider\");");
                    client.println("var servoP = document.getElementById(\"servoPos\"); servoP.innerHTML = slider.value;");
                    client.println("slider.oninput = function() { slider.value = this.value; servoP.innerHTML = this.value; }");
                    client.println("$.ajaxSetup({timeout:1000}); function servo(pos) { ");
                    client.println("$.get(\"/?value=\" + pos + \"&\"); {Connection: close};}</script>");
                   
                    client.println("</body></html>");     
                    
                    //GET /?value=180& HTTP/1.1
                    if(header.indexOf("GET /?value=")>=0) {
                      pos1 = header.indexOf('=');
                      pos2 = header.indexOf('&');
                      valueString = header.substring(pos1+1, pos2);
                      
                      //Rotate the servo
                      myservo.write(valueString.toInt());
                      Serial.println(valueString); 
                    }         
                    // The HTTP response ends with another blank line
                    client.println();
                    // Break out of the while loop
                    break;
                  } else { // if you got a newline, then clear currentLine
                    currentLine = "";
                  }
                } else if (c != '\r') {  // if you got anything else but a carriage return character,
                  currentLine += c;      // add it to the end of the currentLine
                }
              }
            }
            // Clear the header variable
            header = "";
            // Close the connection
            client.stop();
            Serial.println("Client disconnected.");
            Serial.println("");
          }
        }
      </code></pre>

      <p> I then copied the code below into a new Sublime Text file and saved it as an HTML file. You can also use Notepad for this step if you want! </p>

      <!-- 
      <pre><code class="language-html">
        <!DOCTYPE html>
        <html>
        <head>
          <meta name="viewport" content="width=device-width, initial-scale=1">
          <link rel="icon" href="data:,">
          <style>
            body {
              text-align: center;
              font-family: "Trebuchet MS", Arial;
              margin-left:auto;
              margin-right:auto;
            }
            .slider {
              width: 300px;
            }
          </style>
          <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
        </head>
        <body>
          <h1>ESP32 with Servo</h1>
          <p>Position: <span id="servoPos"></span></p>
          <input type="range" min="0" max="180" class="slider" id="servoSlider" onchange="servo(this.value)"/>
          <script>
            var slider = document.getElementById("servoSlider");
            var servoP = document.getElementById("servoPos");
            servoP.innerHTML = slider.value;
            slider.oninput = function() {
              slider.value = this.value;
              servoP.innerHTML = this.value;
            }
            $.ajaxSetup({timeout:1000});
            function servo(pos) {
              $.get("/?value=" + pos + "&");
              {Connection: close};
            }
          </script>
        </body>
        </html>
      </code></pre>
      -->



      </p></h5>

    </div>  
    </div>    
  </body>
</div>

<div class="w3-row-padding w3-padding-large w3-pale-yellow" style="margin-bottom:32px">

  <div class="w3-clear nextprev">
    <a class="w3-button w3-black w3-left" href="../08/index8.html"><i class="fa fa-chevron-left w3-margin-right"></i>Previous</a>
    <a class="w3-button w3-black w3-right" style="margin-right:25px" href="../10/index10.html">Next<i class="fa fa-chevron-right w3-margin-left"></i></a>
  </div>
</div>

</div>
  <div class="w3-center w3-padding w3-black" style="margin-left:225px"><p>Powered by <a href="https://www.w3schools.com/w3css/default.asp" title="W3.CSS" target="_blank" class="w3-hover-opacity">w3.css</a></p><p>Mohammed Mutaher 2022</p></div>
</div>

</html>